FROM eric11eca/meta_kg_1:latest

# Set default shell to /bin/bash
SHELL ["/bin/bash", "-cu"]

WORKDIR /

# Find your username by running `id -un` on HaaS and fill it here
ENV USER_NAME=zechen
ENV USER_ID=1000
ENV GROUP_NAME=zechen
ENV GROUP_ID=1000

RUN --mount=type=secret,id=my_env source /run/secrets/my_env && \
    groupadd -g ${GROUP_ID} ${GROUP_NAME} && \
    useradd -rm -d /home/${USER_NAME} -s /bin/bash -g ${GROUP_ID} -u ${USER_ID} ${USER_NAME} && \
    chown ${USER_ID} -R /home/${USER_NAME} && \
    # Change the password to make root > user
    echo -e "${USER_NAME}\n${USER_NAME}" | passwd ${USER_NAME}

WORKDIR /nlp

# Install OpenSSH for MPI to communicate between containers
RUN apt-get update && apt-get install -y --no-install-recommends openssh-client openssh-server && \
    mkdir -p /var/run/sshd
# RUN echo 'root:root' | chpasswd
RUN sed -i 's/#*PermitRootLogin prohibit-password/PermitRootLogin yes/g' /etc/ssh/sshd_config
# SSH login fix. Otherwise user is kicked off after login
RUN sed -i 's@session\s*required\s*pam_loginuid.so@session optional pam_loginuid.so@g' /etc/pam.d/sshd
ENV NOTVISIBLE="in users profile"
RUN echo "export VISIBLE=now" >> /etc/profile
EXPOSE 22

# Prepare the NFS mount folder
RUN mkdir /mnt/nlpdata1
RUN mkdir /mnt/scratch

ARG DUMMY=unknown
RUN DUMMY=${DUMMY}
RUN mkdir -p /nlp
RUN mkdir -p /nlp/output/
RUN mkdir -p /nlp/tensor/
COPY meta_kg/ /nlp/meta_kg/
COPY run_maml.py /nlp/
COPY cli_maml.py /nlp/
COPY run_eval.sh /nlp/
COPY run_gpt2.sh /nlp/

ENV WANDB_API_KEY 9edee5b624841e10c88fcf161d8dc54d4efbee29

# NOTE: IF YOU ARE NOT USING THE NFS FEEL FREE TO REMOVE THE FOLLOWING 2 INSTRUCTIONS
# Changing the ownership of the /home/USER folder, so that the files created by root can be accesible (e.g. git cloned repo)
# Otherwise by default, they are owned by root
RUN --mount=type=secret,id=my_env source /run/secrets/my_env && \
    chown ${USER_ID} -R /home/${USER_NAME} 

# Switch to user instead of root for NFS + home directory access
USER ${USER_NAME}

ENTRYPOINT ["/usr/sbin/sshd", "-D"]
# ENTRYPOINT ["./entrypoint.sh"]
